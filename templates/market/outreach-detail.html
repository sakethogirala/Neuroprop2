{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <h4 class="page-title">Outreach Detail</h4>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class=""><a href="{% url 'tracker-detail' prospect.pk %}">{{ prospect.name }}</a></h3>
                        <!-- project title-->
                        <div class="badge badge-lg text-bg-{{ prospect.get_progress_class }}">
                            {{ prospect.get_status_display }}</div>
                    </div>

                        <div>
                            <h5>Address</h5>
                            {{ prospect.address.get_address|linebreaks }}
                        </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-4">
                                <h5>Property Type</h5>
                                <p>{{ prospect.get_property_type_display }}</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-4">
                                <h5>Purpose Type</h5>
                                <p>{{ prospect.get_purpose_display }}</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-4">
                                <h5>Amount</h5>
                                <p>${{ prospect.amount }}</p>
                            </div>
                        </div>
                    </div>

                </div> <!-- end card-body-->

            </div> <!-- end card-->
            <div class="card">
                <div class="d-flex card-header justify-content-between align-items-center">
                    <h4 class="header-title">Email Info</h4>
                </div>
                <div class="card-body">
                    <div class="row">

                        <div class="mb-3">
                            <label for="">Email Subject</label>
                            <input id="subject" required name="subject" type="text" placeholder="Email Subject" class="form-control" value="{{ outreach.email_subject }}">
                        </div>
                        <div class="mb-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <h5>Email Content</h5>
                                <a href="{% url 'generate_smart_outreach' outreach.pk %}" class="btn btn-sm btn-primary my-1">Generate Smart Email</a>
                            </div>
                        {% if outreach.email_content %}
                                <textarea id="email-content" rows="20" name="email_content" class="w-100 form-control">{{ outreach.email_content|safe }}</textarea>
                        {% else %}
                        {% if outreach.openai_outreach_time_start %}
                        <p id="loading" class="placeholder-glow">
                            <span class="placeholder col-12"></span>
                            <span class="placeholder col-12"></span>
                            <span class="placeholder col-12"></span>
                            <span class="placeholder col-4"></span>
                        </p>
                        {% else %}
                        <div class="text-center text-muted">Please generate a smart email.</div>
                        {% endif %}
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="">Schedule call URL (optional)</label>
                        <input value="{{ outreach.schedule_call_url }}" id="schedule-call-url" name="schedule-call-url" type="url" placeholder="URL to schedule a call, eg: Calendy link" class="form-control">
                    </div>
                    <div class="mb-3">
                        <button id="send-outreach-btn" class="btn btn-primary w-100">Send Emails <i class="mdi mdi-airplane ms-1"></i></button>
                    </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="d-flex card-header justify-content-between align-items-center">
                    <h4 class="header-title">Lender List</h4>
                </div>
                <div class="card-body pt-0">
                    <div class="float-end text-muted">
                    {% if outreach.email_sent_start %}
                    <div>Email sequences started at {{ outreach.email_sent_start }}</div>
                    {% endif %}
                    {% if outreach.email_sent_start %}
                    <div>Email sequences finished at {{ outreach.email_sent_end }}</div>
                    {% endif %}
                    </div>
                    
                </div>
                    <div class="table-responsive">
                        <table class="table table-centered table-nowrap table-hover mb-0">
                            <tbody>
                                {% for lender in outreach.lenders.all %}
                                <tr>
                                    <td>
                                        <h5 class="font-14 my-1 fw-normal">{{ lender.title }}</h5>
                                        <span class="text-muted font-13">Name</span>
                                    </td>
                                    <td>
                                        <h5 class="font-14 my-1 fw-normal">{{ lender.data.contact }}</h5>
                                        <span class="text-muted font-13">Email</span>
                                    </td>
                                    <td class="table-action">
                                        <a href="{% url 'edit_lender' lender.pk %}" class="action-icon"> <i class="mdi mdi-pencil"></i></a>
                                        <a href="{% url 'remove_lender' outreach.pk lender.pk %}" class="action-icon"> <i class="mdi mdi-delete"></i></a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div> <!-- end table-responsive-->
                </div> <!-- end card-body-->
            </div> <!-- end card-->
        </div> <!-- end col-->

        <!-- end col -->

    </div>
</div>
{% include 'market/send-outreach-modal.html' %}
{% endblock %}

{% block js %}
<script>
let loading = document.getElementById("loading");
if (loading) {
    console.log("loading");
    var refreshInterval = 10000; // 5 seconds
    setTimeout(function() {
        window.location.reload();
    }, refreshInterval);

} else {
    console.log("not loading");
}

</script>
<script>
    document.getElementById('send-outreach-btn').addEventListener('click', function(e) {
    e.preventDefault(); // Prevent default form submission

    let saveEndpoint = `{% url 'save_outreach' outreach.pk %}`;
    let previewEndpoint = `{% url 'view_outreach_preview' outreach.pk %}`;
    
    // Data to be sent (adjust according to your form structure)
    let formData = new FormData();
    formData.append('email-subject', document.getElementById('subject').value);
    formData.append('email-content', document.getElementById("email-content").value);
    formData.append("schedule-call-url", document.getElementById("schedule-call-url").value);
    // Add other form data as needed

    // First, send the save_outreach POST request
    fetch(saveEndpoint, {
        method: 'POST',
        headers: {
                "X-CSRFToken": getCookie('csrftoken'),
            },
        body: formData
    })
    .then(data => {
        console.log('Save Outreach Response:', data);
        // After saving, proceed to fetch the email preview
        fetchEmailPreview(previewEndpoint);
    })
    .catch(error => {
        console.error('Error saving outreach:', error);
    });
});

// Function to fetch email preview
function fetchEmailPreview(endpoint) {
    fetch(endpoint)
    .then(response => response.json())
    .then(data => {
        let modalBody = document.getElementById('email-preview');
        modalBody.innerHTML = data.html;
        var myModal = new bootstrap.Modal(document.getElementById('send-outreach-modal'));
        myModal.show(); 
    })
    .catch(error => {
        console.error('Error fetching email preview:', error);
    });
}

</script>
{% endblock %}